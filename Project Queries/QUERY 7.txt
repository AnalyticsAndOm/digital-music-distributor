-- FIND OUT THE PERCENTAGE OF PAID AND FREE SONGS OPTED BY EACH USER
SELECT 
	USER_ID, CONCAT(USER_FIRST_NAME," ", USER_LAST_NAME) AS USERNAME, 
	ROUND(PAID_SONGS_NUMBER*100 / (PAID_SONGS_NUMBER + FREE_SONGS_NUMBER),2) PAID_SONGS_PERCENTAGE,
	ROUND(FREE_SONGS_NUMBER*100 / (PAID_SONGS_NUMBER + FREE_SONGS_NUMBER),2) FREE_SONGS_PERCENTAGE
FROM 
(
SELECT DISTINCT 
	USER_ID, USER_FIRST_NAME, USER_LAST_NAME,
	SUM(CASE SONG_LEVEL WHEN 'paid' THEN NO_ITEMS_IN_SESSION else 0 END) OVER(PARTITION BY USER_ID) AS PAID_SONGS_NUMBER,
	SUM(CASE SONG_LEVEL WHEN 'free' THEN NO_ITEMS_IN_SESSION else 0 END) OVER(PARTITION BY USER_ID) AS FREE_SONGS_NUMBER
FROM EVENTS
WHERE SONG_NAME IS NOT NULL 
) AS SUB_Q7 
ORDER BY PAID_SONGS_PERCENTAGE DESC;